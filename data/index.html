<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>骑云FPV竞速计时系统</title>
  <link rel="icon" type="image/png" href="favicon.ico" />
  <link rel="stylesheet" type="text/css" href="style.css" />
  <script src="jquery-3.7.1.min.js"></script>
  <script src="articulate.min.js"></script>
  <script src="smoothie.js"></script>
</head>

<body>
<!-- 浮窗提示容器 -->
<div id="toast-container" class="toast-container"></div>
  <header>
    <nav>
      <div class="logo">
        <img id="logo-img" src="favicon.ico" alt="QiYun-FPV" width="64" />
        <h2>骑云FPV竞速计时系统</h2>
      </div>
    </nav>
    <ul class="nav-links">
      <li><a id="nav-link-config" class="tablinks active" onclick="openTab(event, 'config')">配置</a></li>
      <li><a id="nav-link-race" class="tablinks" onclick="openTab(event, 'race')">比赛</a></li>
      <li><a id="nav-link-calib" class="tablinks" onclick="openTab(event, 'calib')">校准</a></li>
      <li><a id="nav-link-ota" class="tablinks" onclick="openTab(event, 'ota')">更新</a></li>
    </ul>
  </header>

  <main>
    <div id="config" class="tabcontent">
      <div class="config-container">
        <!-- 射频相关设置区域 -->
        <div class="config-section">
          <h3>射频设置</h3>
          <div id="bandChannelFreq" class="section-content">
            <div class="config-item">
              <label for="bandSelect">频段:</label>
              <select id="bandSelect">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="R">R</option>
                <option value="L">L</option>
              </select>
            </div>

            <div class="config-item">
              <label for="channelSelect">频道:</label>
              <select id="channelSelect">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
              </select>
            </div>

            <div class="config-item">
              <label>当前频率:</label>
              <span id="freqOutput" class="freq-display"></span>
            </div>
          </div>
        </div>

        <!-- 计时相关设置区域 -->
        <div class="config-section">
          <h3>计时设置</h3>
          <div class="section-content">
            <div class="config-item">
              <label for="minLap">最小圈时:</label>
              <div class="input-with-value">
                <span class="val">10.0s</span>
                <input type="range" id="minLap" step="0.5" min="1" max="10" value="10.0"
                  oninput="updateMinLap(this,value)" />
              </div>
            </div>
          </div>
        </div>

        <!-- 告警与播报设置区域 -->
        <div class="config-section">
          <h3>告警与播报</h3>
          <div class="section-content">
            <div class="config-item">
              <label for="alarmThreshold">低电压告警:</label>
              <div class="input-with-value">
                <span class="val">3.6v</span>
                <input type="range" id="alarmThreshold" step="0.1" min="2.6" max="3.6" value="3.0"
                  oninput="updateAlarmThreshold(this,value)" />
              </div>
            </div>

            <div class="config-item">
          <label for="announcerSelect">播报类型:</label>
          <select id="announcerSelect">
            <option value="0">关闭</option>
            <option value="1">蜂鸣</option>
            <option value="2">单圈用时</option>
            <option value="3">累计用时</option>
          </select>
        </div>

            <div class="config-item">
              <label for="rate">播报速率:</label>
              <div class="input-with-value">
                <span class="val">1.0</span>
                <input type="range" min="0.1" max="2" step="0.1" id="rate" value="1.0"
                  oninput="updateAnnouncerRate(this,value)" />
              </div>
            </div>
          </div>
        </div>

        <!-- 用户信息设置区域 -->
        <div class="config-section">
          <h3>用户信息</h3>
          <div class="section-content">
            <div class="config-item">
              <label for="pname">飞手姓名:</label>
              <input type="text" id="pname" maxlength="20" placeholder="输入飞手姓名" />
            </div>
          </div>
        </div>

        <!-- WiFi设置区域 -->
        <div class="config-section">
          <h3>WiFi 设置</h3>
          <div class="section-content">
            <form id="wifiForm">
              <div class="config-item">
                <label for="ssid">WiFi 名称:</label>
                <input type="text" id="ssid" maxlength="32" placeholder="输入WiFi名称" />
              </div>

              <div class="config-item">
                <label for="pwd">WiFi 密码:</label>
                <input type="password" id="pwd" maxlength="32" placeholder="输入WiFi密码" />
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- 操作按钮区域 -->
      <div class="config-buttons">
        <div class="button-group">
          <button type="button" id="EnableAudioButton" onclick="enableAudioLoop()">开启语音</button>
          <button type="button" id="DisableAudioButton" onclick="disableAudioLoop()">关闭语音</button>
          <button type="button" id="GenerateAudioButton" onclick="generateAudio()">测试语音</button>
        </div>
        <div class="button-group main-buttons">
          <button type="button" id="saveRestartButton" onclick="saveAndRestartConfig()">保存配置</button>
        </div>
      </div>
    </div>

    <div id="race" class="tabcontent">
      <span id="timer">00:00:00 秒</span>
      <div class="racebuttons">
        <button type="button" id="startRaceButton" onclick="startRace()">开始</button>
        <button type="button" id="stopRaceButton" onclick="stopRace()" disabled>停止</button>
        <button type="button" id="clearLapsButton" onclick="clearLaps()">清空</button>
      </div>
      <table id="lapTable">
        <tr>
          <th>圈数</th>
          <th>单圈用时</th>
          <th>累计用时</th>
        </tr>
      </table>
    </div>

    <div id="calib" class="tabcontent">
      <div class="calib-container">
        <!-- RSSI 信号监控与阈值设置合并 -->

        <h3>RSSI 信号监控与阈值设置</h3>
        <div class="chart-container">
          <canvas id="rssiChart"></canvas>
        </div>
        <div class="threshold-controls">
          <div class="threshold-item">
            <label for="enter">进入阈值:</label>
            <div class="input-with-value">
              <span id="enterSpan" class="val">120</span>
              <input type="range" min="50" max="255" step="1" id="enter" value="120"
                oninput="updateEnterRssi(this,value)" />
            </div>
          </div>
          <div class="threshold-item">
            <label for="exit">退出阈值:</label>
            <div class="input-with-value">
              <span id="exitSpan" class="val">100</span>
              <input type="range" min="50" max="255" step="1" id="exit" value="100"
                oninput="updateExitRssi(this,value)" />
            </div>
          </div>
        </div>
      </div>

      <!-- 飞机配置与自动校准合并 -->
      <div class="calib-section">
        <h3>飞机配置与校准</h3>
        <div class="config-grid">
          <div class="config-item">
            <label for="droneSizeSelect">飞机大小:</label>
            <select id="droneSizeSelect">
              <option value="2">2 寸</option>
              <option value="5">5 寸</option>
            </select>
          </div>
          <div class="config-item">
            <label>计时门直径:</label>
            <span id="gateDiameterDisplay" class="gate-diameter">-</span>
          </div>
        </div>

        <!-- 自动校准向导 -->
        <div id="calibWizard" class="wizard-container">
          <!-- 步骤1: 开始校准 -->
          <div id="calibStep1" class="wizard-step">
            <div class="step-info">
              <p class="step-description">飞行器通电并放置在起飞台上，点击开始校准自动测量信号强度。</p>
              <div class="current-settings">
                <p>当前: 频段=<span id="currentBand"></span>, 频道=<span id="currentChannel"></span>,
                  频率=<span id="currentFreq"></span>MHz</p>
                <p>飞机大小=<span id="currentDroneSize"></span>, 计时门直径=<span id="currentGateDiameter"></span>cm</p>
              </div>
            </div>
            <div class="step-controls">
              <button type="button" class="primary-btn" onclick="startCalib()">开始校准</button>
            </div>
          </div>

          <!-- 步骤2: 校准进行中 -->
          <div id="calibStep2" class="wizard-step hidden">
            <div class="step-info">
              <p class="step-description">校准进行中，请不要移动飞行器...</p>
              <div class="calib-progress">
                <div class="progress-item">
                  <span>RSSI值:</span>
                  <span id="calibNoiseVal" class="progress-value">0</span>
                </div>
                <div class="progress-item">
                  <span>进度:</span>
                  <span id="calibNoiseSamples" class="progress-value">0</span>/<span id="calibNoiseTarget">0</span>
                </div>
                <div class="progress-item">
                  <span>推荐:</span>
                  <span>进入=<span id="liveRecEnterNoise">-</span>, 退出=<span id="liveRecExitNoise">-</span></span>
                </div>
              </div>
            </div>
            <div class="step-controls">
              <button type="button" class="secondary-btn" onclick="stopCalib()">停止校准</button>
            </div>
          </div>

          <!-- 步骤3: 校准结果确认 -->
          <div id="calibStep3" class="wizard-step hidden">
            <div class="step-info">
              <div class="calib-results">
                <div class="result-item">
                  <span class="result-label">底噪:</span>
                  <span id="resNoise" class="result-value">-</span>
                </div>
                <div class="result-item">
                  <span class="result-label">峰值:</span>
                  <span id="resPeak" class="result-value">-</span>
                </div>
                <div class="result-item">
                  <span class="result-label">信号强度差:</span>
                  <span id="resDelta" class="result-value">-</span>
                  <span class="result-unit">(要求≥<span id="resMinDelta">-</span>)</span>
                </div>
                <div class="result-item">
                  <span class="result-label">推荐配置:</span>
                  <span class="result-value">进入=<span id="recEnter">-</span>, 退出=<span id="recExit">-</span></span>
                </div>
              </div>
              <p class="step-note">滑块已自动调整到推荐值，您可以手动微调。</p>
            </div>
            <div class="step-controls">
              <button type="button" class="primary-btn" onclick="applyCalib()">应用并保存</button>
              <button type="button" class="secondary-btn" onclick="resetCalib()">取消</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 高级设置（可折叠） -->
      <div class="calib-section">
        <div class="section-header" onclick="toggleAdvancedSettings()">
          <h3>高级设置</h3>
          <span id="advancedToggle">▼</span>
        </div>
        <div id="advancedConfig" class="advanced-config hidden">
          <div class="config-item">
            <label for="calibDropPercentage">RSSI降低量(百分比):</label>
            <input type="number" id="calibDropPercentage" min="10" max="100" step="1" value="30" />
          </div>
          <div class="config-item">
            <label for="calibDropDuration">降低持续时间(秒):</label>
            <input type="number" id="calibDropDuration" min="1" max="30" step="1" value="10" />
          </div>
          <div class="config-item">
            <label for="calibSamples">采样次数:</label>
            <input type="number" id="calibSamples" min="10" max="200" step="1" value="20" />
          </div>
        </div>
      </div>

      <!-- 主操作按钮 -->
      <div class="calib-actions">
        <button type="button" class="save-btn" onclick="saveConfig()">保存设置</button>
      </div>

    </div>

    <div id="ota" class="tabcontent">
      <div class="firmware-update">
        <iframe id="ota-iframe" title="Firmware Update" src="" width="100%" height="600px" frameborder="0"
          sandbox="allow-scripts allow-forms"></iframe>
      </div>
    </div>
  </main>

  <footer>
    <p>Powered by <a href="https://github.com/onebody/QiYun-LapTimer-Node" target="_blank"
        rel="noopener noreferrer">杭州骑云</a><span id="firmware-version"></span></p>
  </footer>

  <script src="script.js"></script>
</body>

</html>